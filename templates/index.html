{% extends 'layout.html' %}

{% block title %}Generate Playlist - TuneForge{% endblock %}

{% block content %}
<div class="content-container">
    <h1>Generate Playlist</h1>
    
    <div class="playlist-container">
        <form id="playlistForm">
            <div class="settings-section">
                <div class="form-group">
                    <label for="playlist_name">Playlist Name:</label>
                    <input type="text" id="playlist_name" name="playlist_name" class="form-control" placeholder="Enter playlist name (optional)">
                </div>
                
                <div class="form-group">
                    <label for="playlist_description">Playlist Description:</label>
                    <textarea id="playlist_description" name="playlist_description" class="form-control" rows="2" placeholder="Enter a description for your playlist (optional)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="num_songs">Number of Tracks:</label>
                    <select id="num_songs" name="num_songs" class="form-control">
                        <option value="5">5 tracks</option>
                        <option value="10" selected>10 tracks</option>
                        <option value="15">15 tracks</option>
                        <option value="20">20 tracks</option>
                        <option value="25">25 tracks</option>
                        <option value="30">30 tracks</option>
                        <option value="40">40 tracks</option>
                        <option value="50">50 tracks</option>
                        <option value="75">75 tracks</option>
                        <option value="100">100 tracks</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="likes">My Likes:</label>
                    <textarea id="likes" name="likes" class="form-control" rows="3" placeholder="Genres, artists, moods that you like">{{ likes }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="dislikes">My Dislikes:</label>
                    <textarea id="dislikes" name="dislikes" class="form-control" rows="3" placeholder="Genres, artists, moods that you dislike">{{ dislikes }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="artist_input">Add Favorite Artist:</label>
                    <div class="input-group">
                        <input type="text" id="artist_input" class="form-control" placeholder="Enter artist name">
                        <button type="button" id="add_artist" class="secondary-button">Add</button>
                    </div>
                </div>
                
                <input type="hidden" id="favorite_artists" name="favorite_artists" value="{{ favorite_artists }}">
                
                <div class="form-group">
                    <label>Favorite Artists:</label>
                    <ul id="artist_list" class="list-group"></ul>
                </div>
                
                <div class="form-group">
                    <button type="submit" name="action" value="generate" class="primary-button">Generate Playlist</button>
                </div>
            </div>
        </form>
        
        <div id="loading" style="display:none;" class="loading-large">
            <p>Generating playlist, please wait...</p>
        </div>
        
        <div class="results-container">
            <h2>Console Output</h2>
            <div id="console_output" class="console-output"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function updateHiddenInput() {
            const listItems = document.querySelectorAll('#artist_list li');
            const artists = Array.from(listItems).map(item => item.querySelector('.artist-name').textContent);
            document.getElementById('favorite_artists').value = artists.join(', ');
        }
        
        function addArtist() {
            const input = document.getElementById('artist_input');
            const artistName = input.value.trim();
            if (artistName === '') return;
            
            const li = document.createElement('li');
            li.className = "list-group-item";
            
            const artistSpan = document.createElement('span');
            artistSpan.className = 'artist-name';
            artistSpan.textContent = artistName;
            li.appendChild(artistSpan);
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = "text-button";
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = function() { 
                li.remove(); 
                updateHiddenInput(); 
            };
            li.appendChild(removeBtn);
            
            document.getElementById('artist_list').appendChild(li);
            input.value = '';
            updateHiddenInput();
        }
        
        document.getElementById('add_artist').addEventListener('click', addArtist);
        
        // Initialize favorite artists from hidden input
        window.onload = function() {
            const hiddenInput = document.getElementById('favorite_artists');
            const existing = hiddenInput.value;
            if (existing.trim() !== '') {
                const artists = existing.split(',').map(a => a.trim());
                artists.forEach(function(artist) {
                    if (artist !== '') {
                        document.getElementById('artist_input').value = artist;
                        addArtist();
                    }
                });
            }
        };
        
        // Handle form submission for playlist generation
        document.getElementById('playlistForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            document.getElementById('loading').style.display = 'block';
            const outputElement = document.getElementById('console_output');
            outputElement.innerHTML = '<div class="console-line">üöÄ Starting playlist generation...</div>';
            
            // Collect form data
            const formData = new FormData(this);
            const formDataObj = {};
            formData.forEach((value, key) => {
                formDataObj[key] = value;
            });
            
            // Create the payload in the format expected by the API
            const payload = {
                prompt: `Create a playlist with these preferences: 
                    Likes: ${formDataObj.likes}
                    Dislikes: ${formDataObj.dislikes}
                    Favorite Artists: ${formDataObj.favorite_artists}
                    ${formDataObj.playlist_description ? 'Description: ' + formDataObj.playlist_description : ''}`,
                num_songs: parseInt(formDataObj.num_songs) || 10,
                playlist_name: formDataObj.playlist_name || "TuneForge Playlist"
            };
            
            // Start log streaming IMMEDIATELY to capture logs as they happen
            startLogStreaming(outputElement);
            
            // Start the playlist generation
            fetch('/api/generate-playlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                // Show the final result immediately
                displayFinalResult(outputElement, data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                outputElement.innerHTML += `<div class="console-line error">‚ùå Error: ${error}</div>`;
            });
        });
        
        function startLogStreaming(outputElement) {
            console.log('Starting log streaming...');
            outputElement.innerHTML += `<div class="console-line info">üîå Connecting to log stream...</div>`;
            
            // Start real-time log streaming
            const eventSource = new EventSource('/api/logs/stream');
            
            // Store reference to close later
            window.currentEventSource = eventSource;
            
            eventSource.onopen = function(event) {
                console.log('EventSource opened');
                outputElement.innerHTML += `<div class="console-line success">üîó Log stream connected!</div>`;
            };
            
            eventSource.onmessage = function(event) {
                console.log('Received message:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    
                    switch(data.type) {
                        case 'info':
                            outputElement.innerHTML += `<div class="console-line info">‚ÑπÔ∏è ${data.message}</div>`;
                            break;
                        case 'log':
                            // Parse the log message and display it nicely
                            const logMessage = parseLogMessage(data.message);
                            outputElement.innerHTML += `<div class="console-line log">${logMessage}</div>`;
                            break;
                        case 'error':
                            outputElement.innerHTML += `<div class="console-line error">‚ùå ${data.message}</div>`;
                            break;
                        case 'complete':
                            outputElement.innerHTML += `<div class="console-line success">‚úÖ ${data.message}</div>`;
                            // Don't close here - let it keep running to capture more logs
                            break;
                    }
                    
                    // Auto-scroll to bottom
                    outputElement.scrollTop = outputElement.scrollHeight;
                } catch (e) {
                    console.error('Error parsing log message:', e);
                    outputElement.innerHTML += `<div class="console-line error">‚ùå Parse error: ${e.message}</div>`;
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('EventSource error:', event);
                outputElement.innerHTML += `<div class="console-line error">‚ùå Connection error - check browser console</div>`;
                // Don't close on error - let it retry
            };
        }
        
        function parseLogMessage(logLine) {
            // Extract the relevant part of the log message
            if (logLine.includes('Ollama:')) {
                const message = logLine.split('Ollama:')[1]?.trim() || logLine;
                return `ü§ñ ${message}`;
            } else if (logLine.includes('Navidrome:')) {
                const message = logLine.split('Navidrome:')[1]?.trim() || logLine;
                return `üéµ ${message}`;
            } else if (logLine.includes('Playlist Gen:')) {
                const message = logLine.split('Playlist Gen:')[1]?.trim() || logLine;
                return `üìã ${message}`;
            } else {
                return `üìù ${logLine}`;
            }
        }
        
        function displayLogMessage(outputElement, data) {
            let className = 'console-line';
            let icon = 'üìù';
            
            switch(data.status) {
                case 'starting':
                    className += ' info';
                    icon = 'üîÑ';
                    break;
                case 'progress':
                    className += ' info';
                    icon = 'üìù';
                    break;
                case 'complete':
                    className += ' success';
                    icon = '‚úÖ';
                    break;
                case 'error':
                    className += ' error';
                    icon = '‚ùå';
                    break;
            }
            
            outputElement.innerHTML += `<div class="${className}">${icon} ${data.message}</div>`;
            outputElement.scrollTop = outputElement.scrollHeight;
        }
        
        function displayFinalResult(outputElement, data) {
            outputElement.innerHTML += '<div class="console-line">üìä Final Result:</div>';
            outputElement.innerHTML += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            
            if (data.status === 'success') {
                outputElement.innerHTML += '<div class="console-line success">‚úÖ Playlist generation complete!</div>';
            } else if (data.error) {
                outputElement.innerHTML += `<div class="console-line error">‚ùå Error: ${data.error}</div>`;
            }
            
            // Close the event source when we're done
            if (window.currentEventSource) {
                window.currentEventSource.close();
                window.currentEventSource = null;
            }
            
            document.getElementById('loading').style.display = 'none';
        }
    });
</script>
{% endblock %}