{% extends 'layout.html' %}

{% block title %}Musical Agent - TuneForge{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸŽµ Musical Agent</h1>
    <p>Your AI assistant for playlist management.</p>
</div>

<div class="content-container">
    <div class="agent-layout">
        <div class="chat-sidebar">
            <button id="new-chat-btn" class="new-chat-btn">
                <span class="icon">+</span> New Chat
            </button>
            <div class="chat-history-header">Recent Chats</div>
            <div id="chat-history-list" class="chat-history-list">
                <!-- Chat history items will be populated here -->
                <div class="loading-history">Loading history...</div>
            </div>
        </div>

        <div class="chat-main-area">
            <div class="chat-container">
                <div id="chat-window" class="chat-window">
                    <!-- Messages will appear here -->
                    <div class="message agent-message">
                        <div class="message-content">
                            Hello! I'm your Musical Agent. How can I help you with your music today?
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="user-input" placeholder="Type your request here..." autocomplete="off">
                    <button id="send-btn" class="primary-button">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Layout */
    .agent-layout {
        display: flex;
        gap: 20px;
        height: 700px;
        max-width: 2400px;
        margin: 0 auto;
    }

    /* Sidebar */
    .chat-sidebar {
        width: 260px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        padding: 15px;
        flex-shrink: 0;
    }

    .new-chat-btn {
        width: 100%;
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: background-color 0.2s;
        margin-bottom: 15px;
    }

    .new-chat-btn:hover {
        background-color: #0069d9;
    }

    .chat-history-header {
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        font-weight: 600;
        padding-left: 5px;
    }

    .chat-history-list {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .history-item {
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        color: #333;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: background-color 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        group: relative;
    }

    .history-item:hover {
        background-color: #f8f9fa;
    }

    .history-item.active {
        background-color: #e9ecef;
        font-weight: 500;
    }

    .delete-chat-btn {
        opacity: 0;
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 1.1rem;
        transition: opacity 0.2s, background-color 0.2s;
    }

    .history-item:hover .delete-chat-btn {
        opacity: 1;
    }

    .delete-chat-btn:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }

    /* Main Chat Area */
    .chat-main-area {
        flex: 1;
        min-width: 0;
        /* Prevent flex overflow */
    }

    /* Custom styles for chat container (updated) */
    .chat-container {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }

    .chat-window {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        display: flex;
        margin-bottom: 10px;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .user-message {
        justify-content: flex-end;
    }

    .agent-message {
        justify-content: flex-start;
    }

    .message-content {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.5;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .user-message .message-content {
        background-color: #007bff;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .agent-message .message-content {
        background-color: #fff;
        color: #333;
        border-bottom-left-radius: 4px;
        border: 1px solid #e9ecef;
    }

    .chat-input-area {
        padding: 20px;
        border-top: 1px solid #dee2e6;
        background-color: #fff;
        display: flex;
        gap: 12px;
        align-items: center;
    }

    #user-input {
        flex: 1 1 0%;
        min-width: 0;
        padding: 12px 16px;
        border: 1px solid #ced4da;
        border-radius: 24px;
        outline: none;
        transition: all 0.2s;
        font-size: 18px;
    }

    #user-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    }

    #send-btn {
        flex: 0 0 auto;
        width: auto !important;
        min-width: 80px;
        border-radius: 20px;
        padding: 8px 16px;
        height: 40px;
        font-weight: 500;
        font-size: 13px;
        background-color: #007bff;
        color: white;
        border: none;
        transition: background-color 0.2s;
        white-space: nowrap;
    }

    #send-btn:hover {
        background-color: #0069d9;
    }

    /* Loading animation dots */
    .typing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 16px 20px;
        background-color: #fff;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        width: fit-content;
        border: 1px solid #e9ecef;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .dot {
        width: 8px;
        height: 8px;
        background-color: #adb5bd;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    /* Dark mode support */
    [data-bs-theme="dark"] .chat-sidebar {
        background: #2b3035;
        border-color: #495057;
    }

    [data-bs-theme="dark"] .history-item {
        color: #e9ecef;
    }

    [data-bs-theme="dark"] .history-item:hover {
        background-color: #343a40;
    }

    [data-bs-theme="dark"] .history-item.active {
        background-color: #495057;
    }

    [data-bs-theme="dark"] .chat-container {
        background: #2b3035;
        border-color: #495057;
    }

    [data-bs-theme="dark"] .chat-window {
        background-color: #212529;
    }

    [data-bs-theme="dark"] .chat-input-area {
        background-color: #2b3035;
        border-top-color: #495057;
    }

    [data-bs-theme="dark"] #user-input {
        background-color: #212529;
        border-color: #495057;
        color: #fff;
    }

    [data-bs-theme="dark"] #user-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }

    [data-bs-theme="dark"] .agent-message .message-content {
        background-color: #343a40;
        color: #e9ecef;
        border-color: #495057;
    }

    [data-bs-theme="dark"] .typing-indicator {
        background-color: #343a40;
        border-color: #495057;
    }

    [data-bs-theme="dark"] .dot {
        background-color: #6c757d;
    }


    /* Loading message text */
    .loading-message {
        margin-top: 10px;
        font-size: 14px;
        color: #6c757d;
        font-style: italic;
        text-align: center;
        animation: fadeIn 0.3s ease;
    }

    [data-bs-theme="dark"] .loading-message {
        color: #adb5bd;
    }

    /* Markdown rendering styles */
    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4,
    .message-content h5,
    .message-content h6 {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
        font-weight: 600;
    }

    .message-content h1 {
        font-size: 1.5em;
    }

    .message-content h2 {
        font-size: 1.3em;
    }

    .message-content h3 {
        font-size: 1.2em;
    }

    .message-content h4 {
        font-size: 1.1em;
    }

    .message-content ul,
    .message-content ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
    }

    .message-content li {
        margin: 0.25em 0;
    }

    .message-content p {
        margin: 0.5em 0;
    }

    .message-content code {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .message-content pre {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 1em;
        border-radius: 6px;
        overflow-x: auto;
        margin: 0.5em 0;
    }

    .message-content pre code {
        background: none;
        padding: 0;
    }

    .message-content table {
        border-collapse: collapse;
        margin: 0.5em 0;
        width: 100%;
    }

    .message-content table th,
    .message-content table td {
        border: 1px solid #dee2e6;
        padding: 0.5em;
        text-align: left;
    }

    .message-content table th {
        background-color: rgba(0, 0, 0, 0.05);
        font-weight: 600;
    }

    .message-content blockquote {
        border-left: 3px solid #007bff;
        padding-left: 1em;
        margin: 0.5em 0;
        color: #666;
    }

    [data-bs-theme="dark"] .message-content code {
        background-color: rgba(255, 255, 255, 0.1);
    }

    [data-bs-theme="dark"] .message-content pre {
        background-color: rgba(255, 255, 255, 0.1);
    }

    [data-bs-theme="dark"] .message-content table th,
    [data-bs-theme="dark"] .message-content table td {
        border-color: #495057;
    }

    [data-bs-theme="dark"] .message-content table th {
        background-color: rgba(255, 255, 255, 0.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');

        // Use configured webhook URL or fallback to default
        const webhookUrl = '{{ n8n_webhook_url }}' || 'https://n8n.lan/webhook/4284d2aa-27d6-4d8a-806b-2001c5361e15';
        const authToken = '{{ n8n_auth_token }}';

        let currentSessionId = null;

        // Humorous loading messages
        const loadingMessages = [
            "Still thinking...",
            "This is really hard...",
            "Working on it...",
            "Being an AI Agent is not easy...",
            "Be a music curator they said... Easiest job in the world they say... I'd rather be sailing...",
            "I really am working as fast as I can, I promise...",
            "...Be mad at the admin for not optimising me better!",
            "Consulting the music gods...",
            "Rummaging through the library...",
            "This playlist better be worth it...",
            "Maybe I should've been a chatbot instead...",
            "In Soviet Russia, AI Agent wait for you...",
            "Loading musical genius... 99%...",
            "Hang tight, crafting perfection...",
            "Would you like some elevator music while you wait?",
            "Trust me, the wait will be worth it!",
            "Still here! Just very, very busy...",
            "It might be worth the wait, I promise!",
            "Zug zug... Work work...",
            "Cut. It. Out. (Can't, still processing)",
            "Hasta la pasta, baby!",
            "Gag me with a spoon! Still loading...",
            "Like, totally loading to the max!",
            "I'm so sure... this will finish eventually",
            "As if! (But really, I'm working hard)",
            "Talk to the hand... the face is busy loading",
            "Don't have a cow, man!",
            "Eat my shorts! (After I finish loading)",
            "Ay, caramba! Still processing...",
            "D'oh! Longer than expected...",
            "Excellent! *air guitar* But still loading...",
            "Party on, dudes!",
            "Bogus journey... through the database",
            "Station! (But make it a loading station)",
            "Be excellent to each other... while waiting",
            "Strange things are afoot at the Circle K...",
            "Whoa... this is heavy, doc",
            "Nobody puts this AI in a corner!",
            "I carried a watermelon... and this heavy load",
            "You can't handle the truth! (It's still loading)",
            "Show me the money! (Show me the playlist!)",
            "No soup for you! (Until loading finishes)",
            "Serenity now! Insanity later!",
            "The sea was angry that day, my friends... Hence the wait.",
            "These pretzels are making me thirsty! (Will finish your request after I have a drink.)",
            "Yadda yadda yadda... still loading",
            "I'm out there, Jerry, and I'm loving every minute!",
            "Giddy up! (But slowly)",
            "I don't wanna be a pirate! I wanna be loaded!",
            "Who is this? (It's your patient AI, still working)",
            "Simulation running... please insert quarter",
            "All your base are belong to us... eventually",

            // Army of Darkness
            "Klaatu... Barada... Nik*cough*... Still loading!",
            "Shop smart. Shop S-Mart! (But wait for loading first)",
            "Hail to the king, baby! (Still processing)",
            "This... is my BOOMSTICK! (Of loading)",
            "Groovy. But also slow.",
            "Give me some sugar, baby... and some patience",
            "Good. Bad. I'm the one with the loading bar.",
            "Alright you primitive screwheads, listen up!",

            // Duke Nukem
            "I'm here to kick ass and load playlists... and I'm all outta ass",
            "Hail to the king, baby! (Loading edition)",
            "It's time to kick gum and chew ass... wait",
            "Come get some! (After loading)",
            "Damn, I'm good! (But also slow)",
            "Shake it, baby! (The loading bar)",
            "I've got balls of steel! (And patience)",

            // Red Alert
            "Kirov reporting! (Slowly)",
            "Affirmative! (Eventually)",
            "Acknowledged. Processing...",
            "Unit ready! (Almost)",
            "Construction complete... not quite yet",
            "Unable to comply. Building in progress.",
            "Establishing battlefield control... stand by",
            "Insufficient data... gathering more",
            "For the Union! (And the loading bar)",

            // Last Action Hero
            "I'll be back! (After this loads)",
            "Big mistake! (Not really, just taking a while)",
            "To be or not to be... loaded",
            "Rubber baby buggy bumpers! Still processing...",
            "You want to be a farmer? Here's a couple of acres!",

            // Jurassic Park
            "Life, uh, finds a way... to load slowly",
            "Hold onto your butts!",
            "Ah ah ah! You didn't say the magic word!",
            "Clever girl... but a slow loader",
            "Must go faster! Must go faster!",
            "They're moving in herds... of data packets",
            "Welcome... to Jurassic Loading",
            "When you gotta go, you gotta go... but I'm not done loading",
            "Objects in mirror are closer than they appear... but loading isn't",

            // Fringe
            "I've just ingested a heroic dose of LSD... perception may vary",
            "I think we just broke the universe... and the loading time",
            "There's more than one of everything... including wait times",
            "Over here! (Still processing over there)",
            "That's not even remotely plausible... but neither is this wait",
            "I need to go to the lab! (To speed up loading)",

            // Farscape
            "Frell! This is taking forever!",
            "I'm gonna eat you, DRD... right after this loads",
            "Go towards the light... of the completed progress bar",
            "That's my ride! (When loading finishes)",
            "Hezmana! Still processing...",
            "Different quadrant, same loading problems",

            // Battlestar Galactica
            "So say we all! (About patience)",
            "All of this has happened before... all of this will happen again",
            "Frak! Still loading...",
            "By your command... processing",
            "Jump in 5... 4... 3... still calculating",
            "This has all happened before... like the last time you waited",
            "Are you alive? (Checking systems... still loading)",

            // It's Always Sunny
            "The Gang Waits for Loading",
            "I am untethered and my rage knows no bounds! (But patience...)",
            "I've got the stride of a gazelle! (But the speed of loading...)",
            "Wildcard, bitches! Yeehaw! (Still processing)",
            "Can I offer you an egg in this trying time?",
            "Rum ham! (After loading)",
            "Day man! Ah-ah-ah! Fighter of the loading man!",
            "That doesn't sound right, but I don't know enough about AI to dispute it",
            "SEIZE THE GAP! (In patience)",
            "Derivative! (But actually working hard)",
            "I'm gonna say the N word... No, not done loading yet",

            // Bob's Burgers
            "Oh my God... still loading",
            "Alriiight! (But slowly)",
            "This is me now! (Loading forever)",
            "I'm a smart, strong, sensual AI... who loads slowly",
            "Buckle it up, or you'll die! (Wait patiently)",
            "Everything is okay! (Except the speed)",
            "Teddy, no! (Teddy, yes! But also still loading)",
            "Your ass is grass and I'm gonna mow it! (After loading)",

            // Schitt's Creek
            "Ew, David! (At this loading time)",
            "I'd kill for a good loading time, David",
            "Fold in the cheese! (And the patience)",
            "I'm trying very hard not to connect with people right now",
            "I haven't bedazzled anything in years! (Except this loading bar)",
            "A little bit Alexis! (And a lot of loading)",
            "I'm positively bedeviled by loading times",
            "You get murdered first! (While waiting)",
            "Love that journey for me! (Not really)",

            // Clueless
            "As if! (But really, I'm totally working on it)",
            "Ugh, as IF! This is taking forever!",
            "Whatever! (But also, still loading)",
            "I'm totally buggin'! (Over this load time)",
            "You're a virgin who can't drive! (And I'm an AI who can't load faster)",
            "I feel like such a bonehead! (For being slow)",
            "That was way harsh, Tai! (So is this wait)",

            // Bonus classics
            "I see dead pixels... I mean, loading bars",
            "You're gonna need a bigger browser",
            "I'm walking here! I'm walkin' here! (Slowly)",
            "Say hello to my little friend! (The loading spinner)",
            "You shall not pass! (Until loading completes)",
            "My precious... loading time",
            "Roads? Where we're going we don't need roads... just patience",
            "I've seen things you people wouldn't believe... like this loading time",
            "Game over, man! Game over! (Not yet, still loading)",
            "Get away from her, you... Oh, still loading",
            "In space, no one can hear you scream... about slow loading"
        ];

        let loadingMessageInterval = null;
        let loadingMessageElement = null;

        // --- Chat History Functions ---

        async function loadSessions() {
            try {
                const response = await fetch('/api/chat/sessions');
                const sessions = await response.json();
                renderSessionList(sessions);

                // If no current session but sessions exist, load the most recent one
                if (!currentSessionId && sessions.length > 0) {
                    loadChat(sessions[0].id);
                } else if (sessions.length === 0) {
                    startNewChat();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                chatHistoryList.innerHTML = '<div class="error-message">Failed to load history</div>';
            }
        }

        function renderSessionList(sessions) {
            chatHistoryList.innerHTML = '';
            sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = `history-item ${session.id === currentSessionId ? 'active' : ''}`;
                item.onclick = (e) => {
                    // Prevent click if clicking delete button
                    if (e.target.closest('.delete-chat-btn')) return;
                    loadChat(session.id);
                };

                const titleSpan = document.createElement('span');
                titleSpan.innerText = session.title || 'New Chat';
                titleSpan.style.overflow = 'hidden';
                titleSpan.style.textOverflow = 'ellipsis';

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-chat-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = 'Delete Chat';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteChat(session.id);
                };

                item.appendChild(titleSpan);
                item.appendChild(deleteBtn);
                chatHistoryList.appendChild(item);
            });
        }

        async function loadChat(sessionId) {
            if (currentSessionId === sessionId) return;

            // Summarize previous session if it exists
            if (currentSessionId) {
                summarizeSession(currentSessionId);
            }

            try {
                const response = await fetch(`/api/chat/sessions/${sessionId}`);
                if (!response.ok) throw new Error('Failed to load chat');

                const data = await response.json();
                currentSessionId = sessionId;

                // Clear chat window
                chatWindow.innerHTML = '';

                // Render messages
                if (data.messages.length === 0) {
                    // Show welcome message for empty chat
                    appendMessage("Hello! I'm your Musical Agent. How can I help you with your music today?", 'agent');
                } else {
                    data.messages.forEach(msg => {
                        appendMessage(msg.content, msg.role === 'user' ? 'user' : 'agent');
                    });
                }

                // Update active state in sidebar
                loadSessions(); // Re-render list to update active class

            } catch (error) {
                console.error('Error loading chat:', error);
                alert('Failed to load chat session');
            }
        }

        async function startNewChat() {
            currentSessionId = null;
            chatWindow.innerHTML = '';
            appendMessage("Hello! I'm your Musical Agent. How can I help you with your music today?", 'agent');

            // Re-render list to remove active class
            const sessions = await (await fetch('/api/chat/sessions')).json();
            renderSessionList(sessions);
        }

        async function deleteChat(sessionId) {
            if (!confirm('Are you sure you want to delete this chat?')) return;

            try {
                await fetch(`/api/chat/sessions/${sessionId}`, { method: 'DELETE' });
                if (currentSessionId === sessionId) {
                    startNewChat();
                } else {
                    loadSessions();
                }
            } catch (error) {
                console.error('Error deleting chat:', error);
                alert('Failed to delete chat');
            }
        }

        async function saveMessage(sessionId, role, content) {
            try {
                await fetch(`/api/chat/sessions/${sessionId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role, content })
                });
            } catch (error) {
                console.error('Error saving message:', error);
            }
        }

        async function summarizeSession(sessionId) {
            if (!sessionId) return;
            try {
                const response = await fetch(`/api/chat/sessions/${sessionId}/summarize`, {
                    method: 'POST'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        console.log('Session summarized:', data.title);
                        loadSessions(); // Refresh list to show new title
                    }
                }
            } catch (error) {
                console.error('Error summarizing session:', error);
            }
        }

        // Trigger summary when leaving the page/tab
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && currentSessionId) {
                summarizeSession(currentSessionId);
            }
        });

        // --- Existing Chat Functions (Updated) ---

        function appendMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}-message`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Render Markdown for agent, plain text for user
            if (sender === 'agent') {
                // Check if libraries are loaded
                if (typeof marked === 'undefined') {
                    console.error('marked.js library not loaded!');
                    contentDiv.innerText = '[ERROR: Markdown library not loaded] ' + text;
                } else if (typeof DOMPurify === 'undefined') {
                    console.error('DOMPurify library not loaded!');
                    contentDiv.innerText = '[ERROR: DOMPurify library not loaded] ' + text;
                } else {
                    try {
                        // Parse markdown and sanitize HTML
                        const rawHtml = marked.parse(text);
                        const cleanHtml = DOMPurify.sanitize(rawHtml);
                        contentDiv.innerHTML = cleanHtml;
                    } catch (e) {
                        console.error('Error rendering markdown:', e);
                        contentDiv.innerText = text;
                    }
                }
            } else {
                // User message: plain text for safety
                contentDiv.innerText = text;
            }

            msgDiv.appendChild(contentDiv);
            chatWindow.appendChild(msgDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingIndicator() {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message agent-message typing-msg';
            msgDiv.id = 'typing-indicator';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'typing-indicator';

            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                contentDiv.appendChild(dot);
            }

            msgDiv.appendChild(contentDiv);
            chatWindow.appendChild(msgDiv);
            scrollToBottom();

            // Start loading message cycle after 10 seconds
            setTimeout(() => {
                if (document.getElementById('typing-indicator')) {
                    loadingMessageElement = document.createElement('div');
                    loadingMessageElement.className = 'loading-message';
                    loadingMessageElement.id = 'loading-message';
                    // Start with a random message
                    loadingMessageElement.innerText = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
                    chatWindow.appendChild(loadingMessageElement);
                    scrollToBottom();

                    loadingMessageInterval = setInterval(() => {
                        // Pick a random message each time
                        const randomIndex = Math.floor(Math.random() * loadingMessages.length);
                        if (loadingMessageElement) {
                            loadingMessageElement.innerText = loadingMessages[randomIndex];
                        }
                    }, 5000); // Change message every 5 seconds
                }
            }, 10000); // Start after 10 seconds
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }

            // Clear loading message interval and element
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
                loadingMessageInterval = null;
            }
            if (loadingMessageElement) {
                loadingMessageElement.remove();
                loadingMessageElement = null;
            }
        }

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. Create session if needed
            if (!currentSessionId) {
                try {
                    const resp = await fetch('/api/chat/sessions', { method: 'POST' });
                    const data = await resp.json();
                    currentSessionId = data.id;
                    loadSessions(); // Refresh list to show new chat
                } catch (e) {
                    console.error("Failed to create session", e);
                    alert("Failed to start chat session");
                    return;
                }
            }

            // 2. Add user message to UI and DB
            appendMessage(text, 'user');
            userInput.value = '';
            userInput.focus();

            await saveMessage(currentSessionId, 'user', text);
            loadSessions(); // Refresh list to update title

            // 3. Show typing
            showTypingIndicator();

            try {
                // Create AbortController for timeout handling (500 seconds)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 500000); // 500 seconds

                const headers = {
                    'Content-Type': 'application/json'
                };

                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        input: text,
                        uid: currentSessionId // Use persistent session ID
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Remove typing indicator
                removeTypingIndicator();

                // Display response
                let answer = "";
                if (data && data.answer) {
                    answer = data.answer;
                } else {
                    answer = "Received a response, but couldn't find the 'answer' field.";
                    console.log("Full response:", data);
                }

                appendMessage(answer, 'agent');
                await saveMessage(currentSessionId, 'assistant', answer);

            } catch (error) {
                removeTypingIndicator();
                let errorMsg = "";
                if (error.name === 'AbortError') {
                    errorMsg = 'Request timed out after 500 seconds. The request may still be processing. Please try again or check if the request completed.';
                } else {
                    errorMsg = `Error: ${error.message}. Please try again later.`;
                }
                appendMessage(errorMsg, 'agent');
                await saveMessage(currentSessionId, 'assistant', errorMsg);
                console.error('Error:', error);
            }
        }

        sendBtn.addEventListener('click', handleSend);
        newChatBtn.addEventListener('click', startNewChat);

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });

        // Initial load
        loadSessions();
        userInput.focus();
    });
</script>
{% endblock %}